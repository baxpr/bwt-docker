---
procyamlversion: 3.0.0-dev.0

description: https://github.com/baxpr/bwt-docker/

jobtemplate: job_template_v3.txt

containers:
  - name: bwt
    path: bwt-docker_v1.1.0.sif
    source: docker://baxterprogers/bwt-docker:v1.1.0
  - name: fsl
    path: fsl-base_v6.0.7.18.sif
    source: docker://baxterprogers/fsl-base:v6.0.7.18
    
requirements:
  walltime: 0-12
  memory: 16000

inputs:
  xnat:
      
    filters:
      - type: match
        inputs: scan_fmri,assr_fmriprep/scan_fmri

    scans:

      - name: scan_fmri
        types: Resting state
        skip_unusable: True

    assessors:
        
        - name: assr_fmriprep
          proctypes: fmriprep_v24
          resources:
            - {resource: fmriprepBIDS, ftype: DIR, fdest: fmriprepBIDS}


outputs:
  - {path: DESPIKED, type: DIR, resource: DESPIKED}
  - {path: NOISE, type: DIR, resource: NOISE}
  - {path: fmri_SP.txt, type: FILE, resource: SP}
  - {path: scaled-fmri.nii.gz, type: FILE, resource: SCALED}


pre:
  type: singularity_exec
  container: fsl
  args: >-
    bash -c \"
    boldref_niigz=\\\$(ls /INPUTS/fmriprepBIDS/fmriprepBIDS/sub-*/ses-*/func/*_space-MNI152NLin2009cAsym_boldref.nii.gz) &&
    preproc_niigz=\\\$(ls /INPUTS/fmriprepBIDS/fmriprepBIDS/sub-*/ses-*/func/*_space-MNI152NLin2009cAsym_desc-preproc_bold.nii.gz) &&
    mask_niigz=\\\$(ls /INPUTS/fmriprepBIDS/fmriprepBIDS/sub-*/ses-*/func/*_space-MNI152NLin2009cAsym_desc-brain_mask.nii.gz) &&
    brainmedian=\\\$(fslstats \\\$boldref_niigz -k \\\$mask_niigz -P 50) &&
    fslmaths \\\$preproc_niigz -div \\\$brainmedian -mul 1000 /OUTPUTS/scaled-fmri.nii.gz
    \"


command:
  type: singularity_exec
  container: bwt
  args: >-
    bash -c \"

      preproc_niigz=\\\$(ls /INPUTS/fmriprepBIDS/fmriprepBIDS/sub-*/ses-*/func/*_space-MNI152NLin2009cAsym_desc-preproc_bold.nii.gz) &&
      fbase=\\\$(basename \\\$preproc_niigz) &&
      wds_niigz=\\\$(echo \\\$fbase | sed 's/desc-preproc_bold/desc-wds_bold/') &&
      noise_niigz=\\\$(echo \\\$fbase | sed 's/desc-preproc_bold/desc-noise_bold/') &&

      echo preproc_niigz \\\$preproc_niigz &&
      echo fbase \\\$fbase &&
      echo wds_niigz \\\$wds_niigz &&
      echo noise_niigz \\\$noise_niigz &&

      run_matlab_entrypoint.sh 
      /opt/matlabruntime/R2023a
      wrapper_WaveletDespike
      /OUTPUTS/scaled-fmri.nii.gz
      /OUTPUTS/fmri
      LimitRAM 12 &&

      mkdir /OUTPUTS/DESPIKED &&
      mv /OUTPUTS/fmri_wds.nii.gz /OUTPUTS/DESPIKED/\\\$wds_niigz &&
      mkdir /OUTPUTS/NOISE &&
      mv /OUTPUTS/fmri_wds.nii.gz /OUTPUTS/NOISE/\\\$noise_niigz
    \"
